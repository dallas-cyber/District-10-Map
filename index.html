<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Turf.js (for “is this point inside the district?”) -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* Map fills the viewport exactly */
    #map {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* Little message bubble */
    #msg {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 10px;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: none;
      max-width: min(92vw, 520px);
      text-align: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
  </style>
</head>

<body>
  <div id="msg"></div>
  <div id="map"></div>

  <script>
    // --- Helpers ---
    const msgEl = document.getElementById("msg");
    let msgTimer = null;

    function showMsg(text, ms = 3500) {
      msgEl.textContent = text;
      msgEl.style.display = "block";
      clearTimeout(msgTimer);
      msgTimer = setTimeout(() => {
        msgEl.style.display = "none";
      }, ms);
    }

    // --- Map init ---
    const map = L.map("map", {
      scrollWheelZoom: false,
      attributionControl: false
    });

    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png").addTo(map);

    // We'll store the VA-10 polygon feature here for Turf checks
    let districtFeature = null;
    let districtBounds = null;

    // --- Geocoder (search box) ---
    // IMPORTANT: We intercept the result and only allow zoom if inside district.
    L.Control.geocoder({
      placeholder: "Search address or place…",
      defaultMarkGeocode: false, // we handle it ourselves
      geocoder: L.Control.Geocoder.nominatim({
        geocodingQueryParams: {
          countrycodes: "us",
          statecodes: "va"
        }
      })
    })
    .on("markgeocode", (e) => {
      // If district isn't loaded yet, allow normal behavior (rare)
      if (!districtFeature) {
        map.fitBounds(e.geocode.bbox);
        return;
      }

      const center = e.geocode.center; // Leaflet LatLng
      const pt = turf.point([center.lng, center.lat]);

      const inside = turf.booleanPointInPolygon(pt, districtFeature);

      if (inside) {
        // Optional: drop a marker where they searched
        if (window._searchMarker) map.removeLayer(window._searchMarker);
        window._searchMarker = L.marker([center.lat, center.lng]).addTo(map);

        map.fitBounds(e.geocode.bbox);
        showMsg("✅ That’s in VA-10.");
      } else {
        showMsg("Looks like that’s not in VA-10. Try respelling or search a nearby town/address.");
        // Optional: snap back to district view (uncomment if you want)
        // if (districtBounds) map.fitBounds(districtBounds);
      }
    })
    .addTo(map);

    // --- District boundary fetch ---
    const geojsonUrl =
      "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_ACS2022/MapServer/50/query?where=STATE%3D%2751%27%20AND%20CD118%3D%2710%27&outFields=*&returnGeometry=true&f=geojson&outSR=4326";

    fetch(geojsonUrl)
      .then(res => res.json())
      .then(data => {
        // The query should return a single feature (VA-10)
        districtFeature = data.features && data.features[0];

        if (!districtFeature) {
          showMsg("District boundary failed to load.");
          return;
        }

        const districtLayer = L.geoJSON(data, {
          style: {
            color: "#696b6d",
            weight: 2,
            fillOpacity: 0.2
          }
        }).addTo(map);

        districtBounds = districtLayer.getBounds();
        map.fitBounds(districtBounds);

        // Critical for iframe/embed sizing
        setTimeout(() => map.invalidateSize(), 100);
      })
      .catch((err) => {
        console.error(err);
        showMsg("Map failed to load.");
      });
  </script>
</body>
</html>
