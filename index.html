<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Turf.js -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #map {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* Message bubble */
    #msg {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 10px;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: none;
      max-width: min(92vw, 520px);
      text-align: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    /* Copyright label */
    #copyright {
      position: fixed;
      bottom: 6px;
      left: 8px;
      z-index: 5000;
      font: 11px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #555;
      background: rgba(255, 255, 255, 0.75);
      padding: 3px 6px;
      border-radius: 4px;
      pointer-events: none;
    }

    /* Geocoder icon -> "Search" text */
    .leaflet-control-geocoder-icon {
      width: auto !important;
      background: none !important;
      text-indent: 0 !important;
    }
    .leaflet-control-geocoder-icon::after {
      content: "Search";
      font: 13px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #333;
      padding: 4px 8px;
    }

    /* Location button (bottom-right) */
    #controls {
      position: fixed;
      bottom: 12px;
      right: 10px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }

    /* Shared button styling */
    .map-btn {
      appearance: none;
      border: 1px solid rgba(208, 208, 208, 0.95);
      background: rgba(255, 255, 255, 0.75); /* slightly transparent */
      padding: 8px 10px;
      border-radius: 10px;
      font: 13px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .map-btn:active { transform: translateY(1px); }

    /* Reset button (bottom center, only shows when district not visible) */
    #resetBtn {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: none; /* hidden by default */
    }
  </style>
</head>

<body>
  <div id="msg"></div>
  <div id="map"></div>

  <!-- Bottom center reset (hidden until needed) -->
  <button id="resetBtn" class="map-btn" type="button">Reset to District 10</button>

  <!-- Bottom-right controls -->
  <div id="controls">
    <button id="locBtn" class="map-btn" type="button">Use My Location</button>
  </div>

  <div id="copyright">© Wong For Congress</div>

  <script>
    // ---- Message helpers ----
    const msgEl = document.getElementById("msg");
    let msgTimer = null;

    function showMsg(text, ms = 3500) {
      msgEl.textContent = text;
      msgEl.style.display = "block";
      clearTimeout(msgTimer);
      msgTimer = setTimeout(() => msgEl.style.display = "none", ms);
    }

    // ---- Map init ----
    const map = L.map("map", {
      scrollWheelZoom: false,
      attributionControl: false
    });

    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png").addTo(map);

    // ---- District data ----
    let districtFeature = null;
    let districtBounds = null;

    // ---- Marker (single marker reused) ----
    let marker = null;

    function placeMarker(latlng, color) {
      if (marker) map.removeLayer(marker);

      marker = L.circleMarker(latlng, {
        radius: 8,
        color: color,
        fillColor: color,
        fillOpacity: 0.85,
        weight: 2
      }).addTo(map);
    }

    function checkPoint(latlng) {
      if (!districtFeature) return null;
      const pt = turf.point([latlng.lng, latlng.lat]);
      return turf.booleanPointInPolygon(pt, districtFeature);
    }

    // ---- Reset visibility logic ----
    const resetBtn = document.getElementById("resetBtn");

    function updateResetVisibility() {
      if (!districtBounds) return;

      // If the current view doesn't intersect the district at all, show reset.
      const districtVisible = map.getBounds().intersects(districtBounds);

      resetBtn.style.display = districtVisible ? "none" : "block";
    }

    map.on("moveend zoomend", updateResetVisibility);

    // ---- Geocoder (collapsed: only "Search" until clicked) ----
    L.Control.geocoder({
      placeholder: "Search address or place…",
      defaultMarkGeocode: false,
      collapsed: true,
      geocoder: L.Control.Geocoder.nominatim({
        geocodingQueryParams: {
          countrycodes: "us",
          statecodes: "va"
        }
      })
    })
    .on("markgeocode", (e) => {
      const center = e.geocode.center;
      const latlng = L.latLng(center.lat, center.lng);

      if (!districtFeature) {
        map.fitBounds(e.geocode.bbox);
        return;
      }

      const inside = checkPoint(latlng);

      if (inside) {
        showMsg("✅ That’s in District 10.");
        placeMarker(latlng, "#1e6cff");
        map.fitBounds(e.geocode.bbox);
      } else {
        showMsg("Looks like that’s not in District 10. Try searching again.");
        placeMarker(latlng, "#d93025");
        map.panTo(latlng, { animate: true });
      }

      // After any search movement, update reset button visibility
      updateResetVisibility();
    })
    .addTo(map);

    // ---- Buttons ----
    resetBtn.addEventListener("click", () => {
      if (districtBounds) {
        map.fitBounds(districtBounds);
        // It’ll auto-hide on moveend/zoomend, but this makes it feel instant
        resetBtn.style.display = "none";
      } else {
        showMsg("District boundary not loaded yet.");
      }
    });

    document.getElementById("locBtn").addEventListener("click", () => {
      if (!navigator.geolocation) {
        showMsg("Geolocation isn’t supported on this device/browser.");
        return;
      }

      showMsg("Getting your location…");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
          const inside = checkPoint(latlng);

          if (inside === null) {
            showMsg("District boundary not loaded yet.");
            return;
          }

          if (inside) {
            showMsg("✅ Your location is in District 10.");
            placeMarker(latlng, "#1e6cff");
            map.setView(latlng, Math.max(map.getZoom(), 13), { animate: true });
          } else {
            showMsg("Looks like that’s not in District 10.");
            placeMarker(latlng, "#d93025");
            map.setView(latlng, map.getZoom(), { animate: true });
          }

          updateResetVisibility();
        },
        (err) => {
          if (err.code === 1) showMsg("Location permission denied.");
          else if (err.code === 2) showMsg("Location unavailable.");
          else showMsg("Couldn’t get your location.");
        },
        {
          enableHighAccuracy: true,
          timeout: 8000,
          maximumAge: 60000
        }
      );
    });

    // ---- Load VA-10 boundary ----
    const geojsonUrl =
      "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_ACS2022/MapServer/50/query?where=STATE%3D%2751%27%20AND%20CD118%3D%2710%27&outFields=*&returnGeometry=true&f=geojson&outSR=4326";

    fetch(geojsonUrl)
      .then(res => res.json())
      .then(data => {
        districtFeature = data.features && data.features[0];

        if (!districtFeature) {
          showMsg("District boundary failed to load.");
          return;
        }

        const layer = L.geoJSON(data, {
          style: {
            color: "#696b6d",
            weight: 2,
            opacity: 0.8,
            fillOpacity: 0.1
          }
        }).addTo(map);

        districtBounds = layer.getBounds();
        map.fitBounds(districtBounds);

        setTimeout(() => {
          map.invalidateSize();
          updateResetVisibility();
        }, 100);
      })
      .catch(err => {
        console.error(err);
        showMsg("Map failed to load.");
      });
  </script>
</body>
</html>
