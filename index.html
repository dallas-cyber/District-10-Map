<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Turf.js (point-in-polygon) -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #map {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* Message bubble (only used for out-of-district) */
    #msg {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 10px;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: none;
      max-width: min(92vw, 520px);
      text-align: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
  </style>
</head>

<body>
  <div id="msg"></div>
  <div id="map"></div>

  <script>
    // ---- Helpers ----
    const msgEl = document.getElementById("msg");
    let msgTimer = null;

    function showMsg(text, ms = 3500) {
      msgEl.textContent = text;
      msgEl.style.display = "block";
      clearTimeout(msgTimer);
      msgTimer = setTimeout(() => {
        msgEl.style.display = "none";
      }, ms);
    }

    function hideMsg() {
      msgEl.style.display = "none";
      clearTimeout(msgTimer);
    }

    // ---- Map init ----
    const map = L.map("map", {
      scrollWheelZoom: false,
      attributionControl: false
    });

    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png").addTo(map);

    // ---- Marker styles ----
    const redIcon = new L.Icon({
      iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
      shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    let searchMarker = null;

    // ---- District storage ----
    let districtFeature = null;
    let districtBounds = null;

    // ---- Geocoder ----
    L.Control.geocoder({
      placeholder: "Search address or place…",
      defaultMarkGeocode: false,
      geocoder: L.Control.Geocoder.nominatim({
        geocodingQueryParams: {
          countrycodes: "us",
          statecodes: "va"
        }
      })
    })
    .on("markgeocode", (e) => {
      const center = e.geocode.center; // Leaflet LatLng
      const latlng = L.latLng(center.lat, center.lng);

      // If district isn't loaded yet, just behave normally.
      if (!districtFeature) {
        map.fitBounds(e.geocode.bbox);
        return;
      }

      const pt = turf.point([center.lng, center.lat]);
      const inside = turf.booleanPointInPolygon(pt, districtFeature);

      // Clear any old marker
      if (searchMarker) {
        map.removeLayer(searchMarker);
        searchMarker = null;
      }

      if (inside) {
        // ✅ In-district: no message. Normal zoom behavior.
        hideMsg();

        // Optional: you can drop a normal marker if you want.
        // If you truly want NOTHING, leave this commented out.
        // searchMarker = L.marker(latlng).addTo(map);

        map.fitBounds(e.geocode.bbox);
      } else {
        // ❌ Out-of-district:
        // - show message
        // - do NOT zoom (keep current zoom)
        // - recenter map so the searched location is centered
        // - add red marker
        showMsg("Looks like that’s not in District 10. Try searching again.");

        map.panTo(latlng, { animate: true });

        searchMarker = L.marker(latlng, { icon: redIcon }).addTo(map);
      }
    })
    .addTo(map);

    // ---- Load District 10 boundary ----
    const geojsonUrl =
      "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_ACS2022/MapServer/50/query?where=STATE%3D%2751%27%20AND%20CD118%3D%2710%27&outFields=*&returnGeometry=true&f=geojson&outSR=4326";

    fetch(geojsonUrl)
      .then(res => res.json())
      .then(data => {
        districtFeature = data.features && data.features[0];

        if (!districtFeature) {
          showMsg("District boundary failed to load.");
          return;
        }

        const districtLayer = L.geoJSON(data, {
          style: {
            color: "#696b6d",
            weight: 2,
            fillOpacity: 0.2
          }
        }).addTo(map);

        districtBounds = districtLayer.getBounds();
        map.fitBounds(districtBounds);

        // Critical for iframe/embed sizing
        setTimeout(() => map.invalidateSize(), 100);
      })
      .catch((err) => {
        console.error(err);
        showMsg("Map failed to load.");
      });
  </script>
</body>
</html>
